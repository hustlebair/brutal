---
interface Props {
  pageTitle?: string;
}

const navigationItems = [
  { name: 'Blog', url: '/blog/' },
];

const categories = [
  { name: 'Cool Tech', items: [] },
  { name: 'Home Stuff', items: [] },
  { name: 'Self Care', items: [] },
  { name: 'LOL Gifts', items: [] },
  { name: 'Adventure', items: [] },
  { name: 'Seasonal', items: [] },
];

const tiktokUrl = 'https://www.tiktok.com/@highestliked';

const { pageTitle } = Astro.props;
---

<header class='site-nav sticky top-0 z-50 bg-white border-b-4 border-black' id='mainNav'>
  {pageTitle && <h1 class='hidden'>{pageTitle}</h1>}
  <div class='container mx-auto px-4'>
    <div class='nav-bar py-3'>
      <!-- Top Row -->
      <div class='relative flex items-center justify-between mb-3 top-row'>
        <!-- Desktop: Search Bar -->
        <div class='hidden md:block search-wrapper'>
          <div class='search-container relative'>
            <input
              type='text'
              id='productSearch'
              placeholder='Search products...'
              class='search-input px-3 py-1.5 pr-8 border-2 border-gray-300 rounded-lg focus:border-[#FCB55B] focus:outline-none text-sm'
            />
            <svg class='search-icon absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
              <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' />
            </svg>
          </div>
        </div>

        <!-- Mobile: Search Icon Button -->
        <button class='md:hidden p-2' id='mobileSearchToggle' aria-label='Toggle search' aria-expanded='false'>
          <svg class='w-6 h-6 text-gray-700' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' />
          </svg>
        </button>

        <!-- Center: Logo (absolutely centered) -->
        <div class='absolute left-1/2 -translate-x-1/2 pointer-events-none'>
          <a href='/' title='Back to Home' class='block pointer-events-auto'>
            <img 
              src='/highestlikedlogo.png' 
              alt='Highest Liked' 
              class='logo-image h-8 md:h-9 w-auto object-contain'
              loading='eager'
            />
          </a>
        </div>

        <!-- Desktop: Navigation Links -->
        <div class='hidden md:flex items-center gap-6'>
          {navigationItems.map((item) => (
            <a
              class='poppins text-base font-semibold hover:text-[#FCB55B] transition-colors'
              href={item.url}
              title={`Go to ${item.name}`}
            >
              {item.name}
            </a>
          ))}
          <a href={tiktokUrl} target='_blank' title='TikTok' aria-label='TikTok' class='inline-flex items-center justify-center'>
            <img src='/icon/tiktokicon.png' alt='TikTok' class='h-6 w-6 object-contain' loading='eager' />
          </a>
        </div>

        <!-- Mobile: Hamburger Menu Button -->
        <button class='md:hidden border-2 border-black px-3 py-2 rounded-lg' id='navToggle' aria-label='Toggle menu' aria-expanded='false'>
          <div class='flex flex-col gap-1.5'>
            <span class='hamburger-line'></span>
            <span class='hamburger-line'></span>
            <span class='hamburger-line'></span>
          </div>
        </button>
      </div>

      <!-- Mobile: Search Popup -->
      <div class='md:hidden hidden mb-3' id='mobileSearchPopup'>
        <div class='relative'>
          <input
            type='text'
            id='productSearchMobile'
            placeholder='Search products...'
            class='w-full px-4 py-2 pr-10 border-2 border-gray-300 rounded-lg focus:border-[#FCB55B] focus:outline-none'
          />
          <svg class='absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' />
          </svg>
        </div>
      </div>

      <!-- Desktop: Categories Row -->
      <div class='hidden md:flex items-center justify-between w-full categories-row'>
        {categories.map((cat) => {
          const categoryUrl = `/?category=${encodeURIComponent(cat.name)}`;
          return (
            <a href={categoryUrl} class='category-link poppins text-sm font-semibold hover:text-[#FCB55B] transition-colors px-4 py-2 rounded-lg hover:bg-[#FFF4E5]'>
              {cat.name}
            </a>
          );
        })}
      </div>
    </div>
  </div>

  <!-- Mobile Menu Overlay -->
  <div class='md:hidden fixed inset-x-0 bg-white border-t-2 border-black shadow-xl hidden' id='mobileMenu'>
    <div class='p-4 max-h-[70vh] overflow-y-auto'>
      {navigationItems.map((item) => (
        <a class='block mb-3 px-4 py-3 bg-gray-100 rounded-lg font-semibold text-gray-900 hover:bg-gray-200' href={item.url}>{item.name}</a>
      ))}
      <a class='block mb-3 px-4 py-3 bg-gray-100 rounded-lg font-semibold text-gray-900 hover:bg-gray-200' href={tiktokUrl} target='_blank'>TikTok</a>
      {categories.map((cat) => {
        const categoryUrl = `/?category=${encodeURIComponent(cat.name)}`;
        return (
          <a class='block mb-3 px-4 py-3 bg-gray-100 rounded-lg font-semibold text-gray-900 hover:bg-gray-200' href={categoryUrl}>{cat.name}</a>
        );
      })}
    </div>
  </div>
</header>

<style>
  .logo-image {
    transition: height 0.3s ease;
  }

  .nav-bar {
    transition: padding 0.3s ease;
  }

  /* Compact state when scrolled (desktop only) */
  @media (min-width: 768px) {
    .site-nav.scrolled .nav-bar {
      padding-top: 0.375rem;
      padding-bottom: 0.375rem;
    }

    .site-nav.scrolled .logo-image {
      height: 1.5rem;
    }

    .site-nav.scrolled .search-container {
      width: 180px;
    }

    .site-nav.scrolled .search-input {
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
      padding-left: 0.5rem;
      font-size: 0.8125rem;
    }

    .site-nav.scrolled .category-link {
      font-size: 0.75rem;
      padding: 0.375rem 0.5rem;
    }

    .site-nav.scrolled .top-row {
      margin-bottom: 0.5rem;
    }
  }

  .search-container {
    width: 200px;
    transition: width 0.3s ease;
  }

  .search-input {
    width: 100%;
    transition: padding 0.3s ease, font-size 0.3s ease;
  }

  .top-row {
    transition: margin-bottom 0.3s ease;
  }

  .hamburger-line {
    width: 20px;
    height: 2px;
    background-color: #000;
    transition: all 0.3s ease;
  }

  #navToggle[aria-expanded="true"] .hamburger-line:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
  }

  #navToggle[aria-expanded="true"] .hamburger-line:nth-child(2) {
    opacity: 0;
  }

  #navToggle[aria-expanded="true"] .hamburger-line:nth-child(3) {
    transform: rotate(-45deg) translate(5px, -5px);
  }

  /* Mobile menu open state */
  #mobileMenu.menu-open {
    display: block !important;
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const navToggle = document.getElementById('navToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    const mobileSearchToggle = document.getElementById('mobileSearchToggle');
    const mobileSearchPopup = document.getElementById('mobileSearchPopup');
    const searchInput = document.getElementById('productSearch') as HTMLInputElement | null;
    const searchInputMobile = document.getElementById('productSearchMobile') as HTMLInputElement | null;
    const header = document.getElementById('mainNav');

    // Search functionality
    const setupSearch = (input: HTMLInputElement | null) => {
      if (!input) return;
      
      let searchTimeout: ReturnType<typeof setTimeout>;
      
      input.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value.trim().toLowerCase();
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          if (!query) {
            window.dispatchEvent(new CustomEvent('searchCleared'));
            return;
          }
          window.dispatchEvent(new CustomEvent('searchPerformed', { detail: { query } }));
        }, 300);
      });
    };

    setupSearch(searchInput);
    setupSearch(searchInputMobile);

    // Mobile menu toggle
    navToggle?.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = mobileMenu?.classList.contains('menu-open');
      
      if (isOpen) {
        mobileMenu?.classList.remove('menu-open');
        mobileMenu?.classList.add('hidden');
        navToggle.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      } else {
        // Close search if open
        if (mobileSearchPopup && !mobileSearchPopup.classList.contains('hidden')) {
          mobileSearchPopup.classList.add('hidden');
          mobileSearchToggle?.setAttribute('aria-expanded', 'false');
        }
        
        mobileMenu?.classList.remove('hidden');
        mobileMenu?.classList.add('menu-open');
        navToggle.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
        
        // Position menu below header
        if (mobileMenu && header) {
          const headerHeight = header.getBoundingClientRect().height;
          mobileMenu.style.top = `${headerHeight}px`;
        }
      }
    });

    // Mobile search toggle
    mobileSearchToggle?.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = !mobileSearchPopup?.classList.contains('hidden');
      
      if (isOpen) {
        mobileSearchPopup?.classList.add('hidden');
        mobileSearchToggle.setAttribute('aria-expanded', 'false');
      } else {
        // Close menu if open
        if (mobileMenu && mobileMenu.classList.contains('menu-open')) {
          mobileMenu.classList.remove('menu-open');
          mobileMenu.classList.add('hidden');
          navToggle?.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }
        
        mobileSearchPopup?.classList.remove('hidden');
        mobileSearchToggle.setAttribute('aria-expanded', 'true');
        setTimeout(() => searchInputMobile?.focus(), 100);
      }
    });

    // Close menu/search when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as Node;
      
      // Close mobile menu if open and clicked outside
      if (mobileMenu && mobileMenu.classList.contains('menu-open')) {
        if (!mobileMenu.contains(target) && !navToggle?.contains(target)) {
          mobileMenu.classList.remove('menu-open');
          mobileMenu.classList.add('hidden');
          navToggle?.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }
      }
      
      // Close search popup if open and clicked outside
      if (mobileSearchPopup && !mobileSearchPopup.classList.contains('hidden')) {
        if (!mobileSearchPopup.contains(target) && !mobileSearchToggle?.contains(target)) {
          mobileSearchPopup.classList.add('hidden');
          mobileSearchToggle?.setAttribute('aria-expanded', 'false');
        }
      }
    });

    // Close menu when clicking on links inside
    mobileMenu?.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.tagName === 'A') {
        mobileMenu.classList.remove('menu-open');
        mobileMenu.classList.add('hidden');
        navToggle?.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }
    });

    // Scroll detection for compact nav
    let scrollInitialized = false;
    
    if (header && !scrollInitialized) {
      scrollInitialized = true;
      let isScrolled = false;
      let isTransitioning = false;
      const SCROLL_THRESHOLD = 60;

      const handleScroll = () => {
        if (isTransitioning) return;
        
        const shouldBeScrolled = window.scrollY > SCROLL_THRESHOLD;
        
        if (shouldBeScrolled !== isScrolled) {
          isTransitioning = true;
          isScrolled = shouldBeScrolled;
          
          requestAnimationFrame(() => {
            if (isScrolled) {
              header.classList.add('scrolled');
            } else {
              header.classList.remove('scrolled');
            }
            
            setTimeout(() => {
              isTransitioning = false;
            }, 350);
          });
        }
      };

      // Initial state
      if (window.scrollY > SCROLL_THRESHOLD) {
        header.classList.add('scrolled');
        isScrolled = true;
      }

      // Throttled scroll listener
      let ticking = false;
      window.addEventListener('scroll', () => {
        if (!ticking) {
          requestAnimationFrame(() => {
            handleScroll();
            ticking = false;
          });
          ticking = true;
        }
      }, { passive: true });
    }
  });
</script>
